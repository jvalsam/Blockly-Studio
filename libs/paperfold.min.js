!function(t){t.fn.paperfold=function(o){function e(o){var e,n=o.css("position"),i="absolute"===n,a=o.parents().filter(function(){var e=t(o);return i&&"static"===e.css("position")?!1:/(auto|scroll)/.test(e.css("overflow")+e.css("overflow-y")+e.css("overflow-x"))}).eq(0);return e=a.length?a:"undefined"!=typeof o[0]?o[0].ownerDocument||document:document,"fixed"===n||e}function n(o,e,n){var i=-o*e,a=-g+o*e+v.data("foldHeight"),d=t("<div>").css(l.topShadow),s=t("<div>").css(l.bottomShadow),r=t("<div>").css(l.top).css("height",e).append(t("<div>").css(l.inner).css("top",i).append(m.clone()).add(d)),h=t("<div>").css(l.bottom).css("height",n).append(t("<div>").css(l.inner).css("bottom",a).append(m.clone()).add(s));return C=C.add(r),y=y.add(h),M=M.add(d.add(s)),t("<div>").css(l.fold).append(r.add(h))}function i(t){var o=v.data("foldHeight")*t,e=b=v.data("foldHeight")/2,n=2*b*o,i=0>=n?90:180*Math.acos((b*b+o*o-e*e)/n)/Math.PI,a=360-i;C.css("transform","rotateX("+a+"deg)"),y.css("transform","rotateX("+i+"deg)");var d=Math.floor(g/v.data("foldCount")*t);H.height(d),M.css("opacity",1-t)}function a(t){var o=(new Date).getTime();c=Math.min(1,(o-f)/h.duration),0===p&&(c=1-c),i(c),h.onProgress(c),h.stayInPlace&&x.scrollTop(u+c*g),c!==p?S(a):1===p&&d()}function d(){H.hide(),v.children().not(H).show()}function s(){H.show(),v.children().not(H).hide()}function r(t){f=(new Date).getTime(),p=t,h.stayInPlace&&(u=x.scrollTop()),S(a)}if(this.length>1)return this.each(function(){t(this).paperfold(o)}),this;var h=t.extend({duration:240,maxFoldHeight:200,folds:null,perspective:"1000px",topShadow:"linear-gradient(transparent, rgba(0,0,0,.5))",bottomShadow:"linear-gradient(rgba(0,0,0,.5), transparent)",isOpen:!1,onProgress:t.noop,stayInPlace:!1},o),l={holder:{height:"",position:"relative",overflow:"hidden"},fold:{height:0,position:"relative",transformStyle:"preserve-3d",perspective:h.perspective,willChange:"height"},side:{overflow:"hidden",width:"100%",willChange:"transform"},top:{transformOrigin:"top",transform:"rotateX(-90deg)",position:"relative"},bottom:{transformOrigin:"bottom",transform:"rotateX(90deg)",position:"absolute",bottom:0},inner:{position:"absolute",width:"100%"},shadow:{position:"absolute",width:"100%",height:"100%",top:0,left:0,willChange:"opacity"},topShadow:{background:h.topShadow},bottomShadow:{background:h.bottomShadow}};l.top=t.extend(l.top,l.side),l.bottom=t.extend(l.bottom,l.side),l.topShadow=t.extend(l.topShadow,l.shadow),l.bottomShadow=t.extend(l.bottomShadow,l.shadow);var c,p,f,u,g,m,w=function(){var t=0;return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(o){var e,n=(new Date).getTime();return e=Math.max(0,16-(n-t)),t=n+e,setTimeout(function(){o(n+e)},e)}}(),v=t(this),S=window.requestAnimationFrame||w,x=e(v),H=t(),y=t(),C=t(),M=t(),P=this;return this.initialize=function(){g=v.show().height(),v.css(l.holder),v.data("foldCount",h.folds||Math.ceil(g/h.maxFoldHeight)),v.data("foldHeight",Math.floor(g/v.data("foldCount"))),m=v.children().clone();for(var t=0,o=0;t<v.data("foldCount");t++,o+=2){var e,i=bottomHeight=v.data("foldHeight")/2;t+1===v.data("foldCount")&&v.data("foldHeight")/2%2&&(bottomHeight=g-(o+1)*i),e=n(o,i,bottomHeight),H=H.add(e),v.append(e)}return h.isOpen?(d(),c=1):(s(),c=0),this},this.percentage=i,this.open=function(){r(1)},this.close=function(){s(),r(0)},this.toggle=function(){.5>c?P.open():P.close()},this.initialize()}}(jQuery);